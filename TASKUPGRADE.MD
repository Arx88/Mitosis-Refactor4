# TASKUPGRADE.MD - Plan de Refactoring para Aislamiento de Tareas y Persistencia

## üìã RESUMEN EJECUTIVO

Despu√©s del an√°lisis exhaustivo del c√≥digo, se ha identificado que el sistema actual de aislamiento de tareas tiene una **arquitectura s√≥lida** pero con **problemas de implementaci√≥n** que causan comportamientos inconsistentes. Este documento define el plan de mejoras para lograr un **aislamiento completo y persistencia robusta**.

## üîç AN√ÅLISIS DEL PROBLEMA ACTUAL

### ‚úÖ **LO QUE EST√Å FUNCIONANDO BIEN**

1. **Context API Robusto**: El `AppContext.tsx` tiene una estructura excelente para aislamiento por tarea
2. **Estructura de Datos Aislados**: Cada tarea tiene su propio espacio en el contexto:
   - `taskMessages[taskId]` - Chat independiente por tarea
   - `taskPlanStates[taskId]` - Plan de acci√≥n independiente
   - `terminalLogs[taskId]` - Terminal independiente
   - `taskFiles[taskId]` - Archivos independientes
   - `taskMonitorPages[taskId]` - Monitor independiente

3. **TaskView Refactorizado**: Ya usa datos aislados del Context

### ‚ùå **PROBLEMAS IDENTIFICADOS**

1. **Inicializaci√≥n Inconsistente**: Las tareas nuevas no siempre inicializan correctamente sus datos aislados
2. **Sincronizaci√≥n Defectuosa**: Los datos entre `Task` object y Context no se sincronizan consistentemente
3. **Persistencia Parcial**: Algunos datos se pierden al cambiar entre tareas
4. **Limpieza Incompleta**: Al crear tareas nuevas, datos antiguos pueden persistir
5. **Hooks de Management Complejos**: `useTaskManagement` tiene l√≥gica compleja que causa conflictos

## üéØ OBJETIVOS DEL REFACTORING

### 1. **AISLAMIENTO COMPLETO**
- Cada tarea debe tener su propia "burbuja" de datos completamente independiente
- Chat, Plan de Acci√≥n, Terminal y Archivos deben ser 100% espec√≠ficos por tarea
- No debe haber "sangrado" de datos entre tareas

### 2. **PERSISTENCIA ROBUSTA**
- Al cambiar de tarea, todos los datos deben persistir correctamente
- Al volver a una tarea, debe cargar exactamente como se dej√≥
- Los datos deben sobrevivir refreshes de p√°gina (si es posible)

### 3. **INICIALIZACI√ìN LIMPIA**
- Las tareas nuevas deben empezar completamente en blanco
- Los datos de tareas anteriores no deben aparecer en tareas nuevas
- La inicializaci√≥n debe ser determin√≠stica y predecible

### 4. **RENDIMIENTO OPTIMIZADO**
- Evitar re-renders innecesarios
- Optimizar la gesti√≥n de memoria
- Mejorar los tiempos de carga al cambiar tareas

## üèóÔ∏è ARQUITECTURA OBJETIVO

### **PRINCIPIO FUNDAMENTAL: "Single Source of Truth" en Context**

```
Context API (AppContext)
‚îú‚îÄ‚îÄ tasks[] (lista de tareas)
‚îú‚îÄ‚îÄ activeTaskId (tarea actual)
‚îî‚îÄ‚îÄ Data Aislado por Tarea:
    ‚îú‚îÄ‚îÄ taskMessages[taskId] ‚Üí Chat independiente
    ‚îú‚îÄ‚îÄ taskPlanStates[taskId] ‚Üí Plan de acci√≥n independiente  
    ‚îú‚îÄ‚îÄ terminalLogs[taskId] ‚Üí Terminal independiente
    ‚îú‚îÄ‚îÄ taskFiles[taskId] ‚Üí Archivos independientes
    ‚îú‚îÄ‚îÄ taskMonitorPages[taskId] ‚Üí Monitor independiente
    ‚îî‚îÄ‚îÄ taskCurrentPageIndex[taskId] ‚Üí Estado UI independiente
```

### **FLUJO DE DATOS SIMPLIFICADO**

1. **Creaci√≥n de Tarea**:
   ```
   Usuario crea tarea ‚Üí Context inicializa datos aislados ‚Üí TaskView lee del Context
   ```

2. **Cambio de Tarea**:
   ```
   Usuario selecciona tarea ‚Üí Context actualiza activeTaskId ‚Üí TaskView lee nuevos datos aislados
   ```

3. **Actualizaci√≥n de Datos**:
   ```
   TaskView actualiza datos ‚Üí Context persiste en datos aislados ‚Üí Otros componentes leen del Context
   ```

## üîß PLAN DE REFACTORING DETALLADO

### **FASE 1: SIMPLIFICAR HOOKS DE MANAGEMENT**

#### 1.1 **Refactoring de `useTaskManagement`**
- **PROBLEMA**: El hook actual es muy complejo y maneja demasiadas responsabilidades
- **SOLUCI√ìN**: Dividirlo en hooks m√°s peque√±os y espec√≠ficos
- **RESULTADO**: L√≥gica m√°s simple y menos propensa a errores

```typescript
// ANTES: Un hook gigante que hace todo
useTaskManagement() // 200+ l√≠neas, muy complejo

// DESPU√âS: Hooks espec√≠ficos
useTaskCRUD()        // Solo crear, leer, actualizar, eliminar tareas
useTaskNavigation()  // Solo navegaci√≥n entre tareas  
useTaskInitialization() // Solo inicializaci√≥n de tareas nuevas
```

#### 1.2 **Eliminaci√≥n de Estado Local Redundante**
- **PROBLEMA**: TaskView tiene estado local que duplica el Context
- **SOLUCI√ìN**: Usar √∫nicamente el Context como fuente de verdad
- **RESULTADO**: Menos inconsistencias y bugs

### **FASE 2: MEJORAR INICIALIZACI√ìN DE TAREAS**

#### 2.1 **Inicializaci√≥n Garantizada**
- **PROBLEMA**: Las tareas nuevas no siempre inicializan correctamente sus datos aislados
- **SOLUCI√ìN**: Crear funci√≥n de inicializaci√≥n robusta que siempre ejecute
- **RESULTADO**: Todas las tareas nuevas empiezan con datos limpios

```typescript
const initializeTaskData = (taskId: string) => {
  // Garantizar que TODOS los espacios aislados existen
  dispatch({ type: 'INITIALIZE_TASK_DATA', payload: { taskId } });
}
```

#### 2.2 **Validaci√≥n de Integridad**
- **PROBLEMA**: Los datos pueden corromperse o perderse
- **SOLUCI√ìN**: Validaciones autom√°ticas al cargar tareas
- **RESULTADO**: Detecci√≥n temprana y correcci√≥n de problemas

### **FASE 3: OPTIMIZAR PERSISTENCIA**

#### 3.1 **Persistencia Autom√°tica**
- **PROBLEMA**: Los datos se pierden al cambiar de tarea
- **SOLUCI√ìN**: Auto-save continuo en Context con debouncing
- **RESULTADO**: Los datos nunca se pierden

#### 3.2 **Carga Lazy de Datos**
- **PROBLEMA**: Todas las tareas cargan datos al mismo tiempo
- **SOLUCI√ìN**: Cargar datos solo cuando se selecciona la tarea
- **RESULTADO**: Mejor rendimiento y uso de memoria

### **FASE 4: LIMPIAR C√ìDIGO DEPRECADO**

#### 4.1 **Eliminar Archivos Hu√©rfanos**
- **PROBLEMA**: Archivos antiguos causan conflictos
- **SOLUCI√ìN**: Identificar y eliminar c√≥digo no utilizado
- **RESULTADO**: Codebase m√°s limpio y mantenible

#### 4.2 **Consolidar L√≥gica Duplicada**
- **PROBLEMA**: M√∫ltiples archivos hacen lo mismo
- **SOLUCI√ìN**: Centralizar l√≥gica com√∫n
- **RESULTADO**: Menos duplicaci√≥n y m√°s consistencia

## üìù LISTA DE VERIFICACI√ìN POST-REFACTORING

### ‚úÖ **TESTS FUNCIONALES**

1. **Test de Aislamiento**:
   - [ ] Crear tarea A con mensaje "Test A"
   - [ ] Crear tarea B con mensaje "Test B"  
   - [ ] Volver a tarea A ‚Üí Debe mostrar solo "Test A"
   - [ ] Volver a tarea B ‚Üí Debe mostrar solo "Test B"

2. **Test de Persistencia**:
   - [ ] Crear tarea con plan de 4 pasos
   - [ ] Completar 2 pasos
   - [ ] Cambiar a otra tarea
   - [ ] Volver ‚Üí Debe mostrar 2 pasos completados

3. **Test de Terminal**:
   - [ ] Ejecutar comandos en tarea A
   - [ ] Cambiar a tarea B
   - [ ] Terminal de B debe estar vac√≠o
   - [ ] Volver a A ‚Üí Debe mostrar comandos anteriores

4. **Test de Archivos**:
   - [ ] Subir archivos a tarea A
   - [ ] Cambiar a tarea B
   - [ ] B no debe mostrar archivos de A
   - [ ] Volver a A ‚Üí Debe mostrar archivos subidos

### ‚úÖ **TESTS DE RENDIMIENTO**

1. **Tiempo de Carga**:
   - [ ] Cambio entre tareas < 200ms
   - [ ] Creaci√≥n de nueva tarea < 500ms
   - [ ] Carga inicial < 1000ms

2. **Uso de Memoria**:
   - [ ] No memory leaks al cambiar tareas
   - [ ] Garbage collection correcto
   - [ ] Crecimiento lineal con n√∫mero de tareas

### ‚úÖ **TESTS DE INTEGRIDAD**

1. **Validaci√≥n de Datos**:
   - [ ] No hay datos mezclados entre tareas
   - [ ] Todas las tareas tienen espacios inicializados
   - [ ] No hay referencias cruzadas

2. **Consistencia de Estado**:
   - [ ] Context y UI siempre sincronizados
   - [ ] No hay estados inconsistentes
   - [ ] Las transiciones son at√≥micas

## üöÄ BENEFICIOS ESPERADOS

### **PARA USUARIOS**
- ‚úÖ **Experiencia Predecible**: Cada tarea funciona independientemente
- ‚úÖ **No P√©rdida de Datos**: Todo se guarda autom√°ticamente
- ‚úÖ **Rendimiento Mejorado**: Cambios instant√°neos entre tareas
- ‚úÖ **Menos Bugs**: Comportamiento consistente y confiable

### **PARA DESARROLLADORES**
- ‚úÖ **C√≥digo M√°s Limpio**: Arquitectura simple y clara
- ‚úÖ **Menos Bugs**: L√≥gica simplificada = menos errores
- ‚úÖ **F√°cil Mantenimiento**: C√≥digo bien organizado y documentado
- ‚úÖ **Extensibilidad**: F√°cil agregar nuevas funcionalidades

## üéØ IMPLEMENTACI√ìN PRIORIZADA

### **CR√çTICO (Hacer Ahora)**
1. Refactoring de `useTaskManagement`
2. Mejorar inicializaci√≥n de tareas
3. Eliminar c√≥digo deprecado
4. Verificar persistencia del chat

### **IMPORTANTE (Hacer Pronto)**
1. Optimizar rendimiento
2. Agregar tests autom√°ticos
3. Documentar APIs internas
4. Mejorar error handling

### **DESEABLE (Hacer Despu√©s)**
1. Persistencia en LocalStorage
2. Backups autom√°ticos
3. M√©tricas de uso
4. Optimizaciones avanzadas

---

## üé≠ CONCLUSI√ìN

El sistema actual tiene **buenas bases arquitect√≥nicas** pero necesita **refinamiento en la implementaci√≥n**. Con este refactoring, lograremos un **agente general con aislamiento perfecto** donde cada tarea funciona como una **aplicaci√≥n completamente independiente** dentro del mismo entorno.

**Objetivo Final**: Un sistema donde crear una nueva tarea sea como abrir una nueva ventana del navegador - completamente aislada, persistente y confiable.